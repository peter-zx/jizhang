# 会计应用系统 - 项目交接文档

## 📋 项目概述

这是一个**分销商管理系统**，用于管理分销商、成员、劳动任务和财务结算。系统采用前后端分离架构。

### 技术栈
- **前端**: React + Vite + React Router
- **后端**: Node.js + Express
- **数据库**: SQLite
- **端口**: 前端 3000 / 后端 5000

### 项目目录
```
accounting-app/
├── server/              # 后端代码
│   ├── config/         # 数据库配置
│   ├── controllers/    # 业务逻辑
│   ├── routes/         # 路由定义
│   ├── middleware/     # 认证中间件
│   └── server.js       # 服务入口
├── src/                # 前端代码
│   ├── pages/          # 页面组件
│   ├── api/            # API调用
│   └── App.jsx         # 主应用
└── data/               # 数据库文件
    └── accounting.db
```

---

## 🎯 核心业务逻辑

### 1. 分销层级架构
- **管理员(admin)**: 最高权限，管理所有分销商和成员
- **A层分销商(distributor_a)**: 佣金比例 6%，可管理自己的成员
- **B层分销商(distributor_b)**: 佣金比例 8%，可管理自己的成员

### 2. 数据流转核心链路 ⚠️ 最重要
```
成员(members) 
  ↓ 设置金额
labor_tasks (劳动任务，存储月度金额)
  ↓ 自动生成
monthly_bills (月度账单)
  ↓ 确认后
accounting_records (账本记录)
```

**关键点**:
- 在"金额管理"设置金额时，必须**同时更新** `labor_tasks` 和 `monthly_bills` 两张表
- 只更新一张表会导致数据不同步显示为空

### 3. 金额参数体系
每个分销商有三个核心金额参数（存储在 `users` 表）:
- `commission_amount`: 佣金金额（每个成员的佣金）
- `deposit_amount`: 保障金金额
- `insurance_amount`: 保险金额

**规则**:
- 分销商首次可设置，之后可随时修改（已移除锁定机制）
- 管理员可随时解锁和修改任何分销商的设置

---

## 🗄️ 数据库结构

### 核心表结构

#### users (用户/分销商)
```sql
- id: 主键
- username: 登录名
- password: 加密密码(bcrypt)
- name: 显示名称
- role: admin/distributor_a/distributor_b
- commission_amount: 佣金金额 (新增字段)
- deposit_amount: 保障金金额 (新增字段)
- insurance_amount: 保险金额 (新增字段)
- settings_locked: 设置是否锁定 (已弃用)
- invite_code: 注册邀请码
```

#### members (成员)
```sql
- id: 主键
- distributor_id: 所属分销商ID (外键 → users.id)
- name: 成员姓名
- status: active(在职)/inactive(离职)
- phone: 电话
- id_number: 身份证号
- bank_account: 银行账号
- documents: 证件文件路径 (JSON)
- additional_info: 附加信息 (JSON)
- contract_files: 合同文件 (JSON)
```

#### labor_tasks (劳动任务) ⚠️ 核心
```sql
- id: 主键
- member_id: 成员ID (外键 → members.id)
- monthly_amount: 月度金额 ⭐ 关键字段
- task_status: active/completed/cancelled
- created_at, updated_at: 时间戳
```

#### monthly_bills (月度账单) ⚠️ 核心
```sql
- id: 主键
- member_id: 成员ID (外键 → members.id)
- distributor_id: 分销商ID
- labor_task_id: 劳动任务ID (可为空)
- bill_month: 账单月份 (格式: YYYY-MM)
- monthly_amount: 月度金额 ⭐ 关键字段
- deposit_confirmed: 是否确认 (0/1)
- confirmed_at: 确认时间
```

#### accounting_records (账本记录)
```sql
- id: 主键
- member_id: 成员ID
- distributor_id: 分销商ID
- record_date: 记录日期
- received_amount: 到账金额
- deposit: 保障金
- insurance: 保险金额
- commission: 佣金
- net_revenue: 净收入
- city: 城市
- notes: 备注
```

---

## 🔧 重要功能实现

### 1. 金额设置 (bulkSetAmount) ⚠️ 最核心
**位置**: `server/controllers/memberController.js`

**必须执行的操作**:
```javascript
// 1. 更新或创建 labor_tasks
UPDATE labor_tasks SET monthly_amount = ? WHERE id = ?
// 或
INSERT INTO labor_tasks (member_id, monthly_amount, task_status) VALUES (?, ?, 'active')

// 2. 同时生成当月的 monthly_bills ⭐ 关键！
INSERT INTO monthly_bills (
  member_id, distributor_id, labor_task_id, 
  bill_month, monthly_amount, deposit_confirmed
) VALUES (?, ?, ?, ?, ?, 0)
```

**如果只做第1步不做第2步，会导致"我的数据"、"月度账单"显示为空！**

### 2. 分销商数据统计
**位置**: `src/pages/DistributorOverview.jsx`

计算逻辑:
```javascript
// 基于在职成员数和佣金金额计算
const memberCount = members.filter(m => m.status === 'active').length
const commissionPerPerson = userInfo.commission_amount || 0
const myCommission = commissionPerPerson * memberCount
const totalRevenue = commissionPerPerson * memberCount
```

### 3. 月度账单批量确认
**位置**: `src/pages/MonthlyBilling.jsx`

新增功能:
- 复选框选择账单
- 全选功能（只选待确认的）
- 批量确认按钮
- 单个确认无弹窗

### 4. 成员删除密码验证
**位置**: `server/controllers/memberController.js`

```javascript
// 删除成员需要验证当前用户密码
const isPasswordValid = await bcrypt.compare(password, user.password)
if (!isPasswordValid) {
  return res.status(401).json({ message: '密码错误' })
}
```

---

## ⚠️ 已知问题和解决方案

### 问题1: SQLite NOT NULL 约束错误
**现象**: `SQLITE_CONSTRAINT: NOT NULL constraint failed`

**原因**: SQLite 不支持 `ALTER COLUMN` 修改约束

**解决方案**: 使用表重建模式
```javascript
// 1. 创建新表（去掉 NOT NULL）
CREATE TABLE IF NOT EXISTS table_new (...)
// 2. 复制数据
INSERT INTO table_new SELECT * FROM table
// 3. 删除旧表
DROP TABLE table
// 4. 重命名新表
ALTER TABLE table_new RENAME TO table
```

**已实现位置**: `server/config/database.js` 的 `migrateDatabase()` 函数

### 问题2: 数据库字段缺失
**解决方案**: 已建立迁移机制，自动添加缺失字段
```javascript
// 使用 ALTER TABLE ADD COLUMN 添加字段
await addColumn('ALTER TABLE users ADD COLUMN commission_amount REAL DEFAULT 0')
```

### 问题3: 金额设置后数据消失
**原因**: 保存后未重新加载数据

**解决方案**: 
```javascript
// 保存成功后使用 await 重新加载
await loadUserInfo()
await loadStats()
```

---

## 🚀 启动和开发

### 启动项目
```bash
cd accounting-app

# 启动后端 (端口 5000)
npm run server

# 启动前端 (端口 3000)
npm run dev
```

### 修改后端代码后
**必须重启后端服务才能生效！**
```bash
# Windows
taskkill /F /IM node.exe
npm run server
```

### 默认账号
```
管理员:
  用户名: admin
  密码: admin
  邀请码: (控制台输出)
```

---

## 📝 开发规范

### 1. 金额输入框规范
- 允许输入 0 值
- 隐藏上下箭头（已在 CSS 实现）
- 支持小数（金额计算）

### 2. 数据一致性原则 ⚠️ 重要
**用户原话**: "数据不容有错。先解决数据同步问题。"

- 设置金额时必须同时更新 `labor_tasks` 和 `monthly_bills`
- 统计数据必须基于实际数据库查询，不能写死为 0
- 在职/离职状态筛选必须生效

### 3. 前端字段映射
API 返回的字段是下划线命名，前端显示需要映射:
```javascript
// API 返回
record.member_name      → 成员姓名
record.record_date      → 日期
record.received_amount  → 到账金额
record.net_revenue      → 净收入
record.distributor_name → 分销商

// 不是驼峰命名！
```

### 4. 安全操作
- 删除成员需要密码验证
- 管理员操作需要权限检查
- 清空数据需要二次确认

---

## 🔍 调试技巧

### 查看日志
后端已添加详细日志，使用 emoji 标记:
```
📝 - 开始操作
✓  - 成功
✅ - 完成
❌ - 错误
```

### 数据库查询
```bash
# 查看数据库文件
cd accounting-app/data
sqlite3 accounting.db

# 常用查询
SELECT * FROM labor_tasks;
SELECT * FROM monthly_bills;
SELECT * FROM members WHERE status = 'active';
```

### 前端调试
- 打开浏览器控制台查看 API 请求
- 查看 Network 面板的响应数据
- 检查 Console 的错误信息

---

## 📦 最近完成的功能

### ✅ 已完成
1. 金额管理功能（允许0值，隐藏箭头）
2. 月度账单批量确认（去掉确认弹窗）
3. 我的数据-金额设置（保存后数据不消失）
4. 账本管理清空功能（管理员专用）
5. 成员删除密码验证
6. 数据同步核心问题修复（labor_tasks + monthly_bills）
7. 移除金额设置锁定机制（允许随时修改）

### ⚠️ 待完成功能
1. 删除成功改为浮窗提示（toast notification）
2. 成员管理上层直接修改在职状态
3. 合同签约和到期日期的完整处理

---

## 🎯 开发建议

### 1. 遇到数据显示为空
**首先检查**:
- `labor_tasks` 表是否有对应成员的记录
- `monthly_bills` 表是否有对应月份的记录
- 统计查询的 SQL 是否正确
- 是否有 `status = 'active'` 的筛选条件

### 2. 修改数据库结构
- 先在 `database.js` 的 `migrateDatabase()` 中添加迁移逻辑
- 使用 `ALTER TABLE ADD COLUMN` 添加字段
- 如需修改约束，使用表重建模式
- 重启后端后检查控制台输出的"✓"标记

### 3. 添加新 API
1. 在 `server/controllers/` 添加控制器函数
2. 在 `server/routes/` 添加路由
3. 在 `src/api/index.js` 添加 API 调用函数
4. 在前端页面调用 API
5. **重启后端服务**

---

## 💡 用户反馈和要求

### 核心要求
> "数据不容有错。先解决数据同步问题。"
> "列任务计划，一个个解决。不追求一次性解决。要确保正确率。"
> "确保分销层数据正确链接调用，并汇总到管理员界面。"
> "注意元数据的保存，并通过映射数据进行计算，避免影响原始数据。"

### 开发风格偏好
- 分步骤解决问题，不追求一次完成
- 优先保证数据正确性
- 清晰的任务计划
- 详细的日志输出

---

## 🔗 关键文件清单

### 后端核心文件
- `server/config/database.js` - 数据库配置和迁移 ⭐
- `server/controllers/memberController.js` - 成员和金额管理 ⭐⭐⭐
- `server/controllers/authController.js` - 认证和设置
- `server/controllers/billingController.js` - 月度账单
- `server/controllers/accountingController.js` - 账本记录

### 前端核心文件
- `src/pages/DistributorOverview.jsx` - 我的数据页面 ⭐⭐
- `src/pages/AmountManagement.jsx` - 金额管理
- `src/pages/MonthlyBilling.jsx` - 月度账单 ⭐
- `src/pages/MemberManagement.jsx` - 成员管理
- `src/pages/AccountingBook.jsx` - 账本管理
- `src/api/index.js` - API 接口定义 ⭐
- `src/styles/App.css` - 全局样式

---

## 📞 常见问题速查

**Q: 金额设置后"当前金额"不显示？**
A: 检查 `bulkSetAmount` 是否同时更新了 `labor_tasks` 和 `monthly_bills`

**Q: 我的数据显示为空？**
A: 检查统计逻辑是否从 `userInfo.commission_amount` 读取，确保有在职成员

**Q: 修改代码后不生效？**
A: 后端代码需要重启服务，前端 Vite 会热更新

**Q: 数据库报错 NOT NULL constraint？**
A: 使用表重建模式修改约束，参考 `database.js` 的实现

**Q: 月度账单没有数据？**
A: 检查设置金额时是否生成了 `monthly_bills` 记录

---

## ✨ 最后的话

这个项目的核心难点在于**数据流转的同步性**。记住：

1. **金额设置 = labor_tasks + monthly_bills 同时更新**
2. **统计显示 = 基于真实数据查询，不能写死**
3. **后端修改 = 必须重启服务**
4. **数据一致性 > 功能完整性**

祝下一位 AI 开发顺利！🚀

---

**文档版本**: v1.0  
**最后更新**: 2026-02-03  
**创建者**: Qoder AI Assistant
